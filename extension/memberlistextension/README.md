# Memberlist Extension

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: extension   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aextension%2Fmemberlist%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aextension%2Fmemberlist) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aextension%2Fmemberlist%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aextension%2Fmemberlist) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | Seeking code owners! |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

The memberlist extension provides cluster membership and node discovery using [HashiCorp's memberlist library](https://github.com/hashicorp/memberlist). This extension implements a gossip-based protocol for maintaining cluster membership information and can be used as a resolver for the [load balancing exporter](../../exporter/loadbalancingexporter/README.md) to dynamically discover backend endpoints.

## Key Features

- **Gossip-based cluster membership**: Uses the SWIM (Scalable Weakly-consistent Infection-style Process Group Membership Protocol) for efficient and reliable cluster membership
- **Dynamic service discovery**: Automatically discovers and tracks cluster members
- **High availability**: Handles network partitions and node failures gracefully
- **Encryption support**: Optional encryption of gossip messages for security
- **Configurable timing**: Tunable parameters for gossip intervals, probe timeouts, and other timing settings
- **Integration with load balancer**: Seamlessly integrates with the load balancing exporter as a resolver

## How It Works

The memberlist extension creates a cluster of OpenTelemetry Collector instances that can discover each other automatically. When used with the load balancing exporter, it provides a dynamic list of available collector endpoints for load balancing telemetry data.

1. **Cluster Formation**: Collectors join the cluster by connecting to existing members
2. **Membership Maintenance**: The gossip protocol continuously monitors member health
3. **Dynamic Updates**: As members join or leave, the extension notifies registered callbacks
4. **Load Balancer Integration**: The load balancing exporter uses these updates to adjust its backend list

## Configuration

### Extension Configuration

```yaml
extensions:
  memberlist:
    # Required: Address to bind for gossip communication
    bind_addr: "127.0.0.1"
    
    # Required: Port to bind for gossip communication (default: 7946)
    bind_port: 7946
    
    # Optional: Address to advertise to other nodes (defaults to bind_addr)
    advertise_addr: "10.0.1.100"
    
    # Optional: Port to advertise to other nodes (defaults to bind_port)
    advertise_port: 7946
    
    # Optional: List of existing cluster members to join
    join_addrs:
      - "10.0.1.10:7946"
      - "10.0.1.11:7946"
    
    # Optional: Name of this node (defaults to hostname)
    node_name: "collector-1"
    
    # Optional: Encryption key for gossip messages (16, 24, or 32 bytes)
    secret_key: "1234567890123456"
    
    # Optional: Timing configurations (defaults shown)
    gossip_interval: 200ms      # How often to gossip
    probe_interval: 1s          # How often to probe a random node
    probe_timeout: 500ms        # Timeout for probe responses
    suspicion_mult: 4           # Multiplier for suspicion timeout
    push_pull_interval: 30s     # How often to do full state sync
    tcp_timeout: 10s            # TCP connection timeout
    indirect_checks: 3          # Number of nodes for indirect pings
    retransmit_mult: 4          # Multiplier for retransmit timeout
```

### Load Balancing Exporter Configuration

```yaml
exporters:
  loadbalancing:
    routing_key: "service"
    protocol:
      otlp:
        timeout: 1s
    resolver:
      memberlist:
        extension_id: "memberlist"  # Reference to the memberlist extension
```

### Complete Example

```yaml
extensions:
  memberlist:
    bind_addr: "0.0.0.0"
    bind_port: 7946
    advertise_addr: "10.0.1.100"
    join_addrs:
      - "10.0.1.10:7946"
      - "10.0.1.11:7946"
    node_name: "collector-cluster1"
    secret_key: "1234567890123456789012345678901234567890"

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: localhost:4317

exporters:
  loadbalancing:
    routing_key: "service"
    protocol:
      otlp:
        timeout: 1s
        tls:
          insecure: true
    resolver:
      memberlist:
        extension_id: "memberlist"

service:
  extensions: [memberlist]
  pipelines:
    traces:
      receivers: [otlp]
      processors: []
      exporters: [loadbalancing]
    logs:
      receivers: [otlp]
      processors: []
      exporters: [loadbalancing]
```

## Configuration Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `bind_addr` | string | **required** | Address to bind for gossip communication |
| `bind_port` | int | 7946 | Port to bind for gossip communication |
| `advertise_addr` | string | `bind_addr` | Address advertised to other nodes |
| `advertise_port` | int | `bind_port` | Port advertised to other nodes |
| `join_addrs` | []string | [] | List of existing cluster members to join |
| `node_name` | string | hostname | Name of this node in the cluster |
| `secret_key` | string | "" | Encryption key (16, 24, or 32 bytes) |
| `gossip_interval` | duration | 200ms | How often to gossip |
| `probe_interval` | duration | 1s | How often to probe a random node |
| `probe_timeout` | duration | 500ms | Timeout for probe responses |
| `suspicion_mult` | int | 4 | Multiplier for suspicion timeout calculation |
| `push_pull_interval` | duration | 30s | How often to do full state sync |
| `tcp_timeout` | duration | 10s | TCP connection timeout |
| `indirect_checks` | int | 3 | Number of nodes for indirect pings |
| `retransmit_mult` | int | 4 | Multiplier for retransmit timeout calculation |

## Use Cases

### 1. Dynamic Load Balancing

Use memberlist with the load balancing exporter to automatically discover and load balance across collector instances:

```yaml
# On each collector instance
extensions:
  memberlist:
    bind_addr: "0.0.0.0"
    bind_port: 7946
    advertise_addr: "${HOST_IP}"  # Set via environment variable
    join_addrs: ["${SEED_NODE}:7946"]

exporters:
  loadbalancing:
    resolver:
      memberlist:
        extension_id: "memberlist"
```

### 2. Multi-Cluster Setup

Run multiple independent clusters using different extension instances:

```yaml
extensions:
  memberlist/cluster1:
    bind_port: 7946
    join_addrs: ["cluster1-seed:7946"]
  
  memberlist/cluster2:
    bind_port: 7947
    join_addrs: ["cluster2-seed:7947"]

exporters:
  loadbalancing/cluster1:
    resolver:
      memberlist:
        extension_id: "memberlist/cluster1"
  
  loadbalancing/cluster2:
    resolver:
      memberlist:
        extension_id: "memberlist/cluster2"
```

### 3. Secure Cluster

Enable encryption for sensitive environments:

```yaml
extensions:
  memberlist:
    bind_addr: "0.0.0.0"
    bind_port: 7946
    secret_key: "${CLUSTER_SECRET_KEY}"  # 32-byte key from environment
    join_addrs: ["${SEED_NODES}"]
```

## Deployment Considerations

### Network Requirements

- **Gossip Port**: All nodes must be able to communicate on the configured gossip port (default 7946)
- **Firewall**: Ensure the gossip port is open between all cluster members
- **NAT/Load Balancers**: Use `advertise_addr` when nodes are behind NAT or load balancers

### Cluster Sizing

- **Small Clusters**: 3-10 nodes work well with default settings
- **Large Clusters**: For 50+ nodes, consider increasing `gossip_interval` and `probe_interval`
- **Network Partitions**: The protocol handles partitions gracefully but may take time to converge

### Security

- **Encryption**: Always use `secret_key` in production environments
- **Network Isolation**: Run clusters in isolated network segments when possible
- **Key Rotation**: Plan for periodic rotation of encryption keys

### Monitoring

The extension logs cluster membership changes and periodic status information:

```
INFO	Node joined cluster	{"node": "collector-2", "addr": "10.0.1.11", "port": 7946}
INFO	Node left cluster	{"node": "collector-3", "addr": "10.0.1.12", "port": 7946}
DEBUG	Cluster status	{"member_count": 5, "members": ["10.0.1.10:7946", "10.0.1.11:7946", ...]}
```

## Troubleshooting

### Common Issues

1. **Nodes not joining cluster**
   - Check network connectivity between nodes
   - Verify `join_addrs` are reachable
   - Ensure gossip ports are not blocked by firewalls

2. **Frequent membership changes**
   - Increase `probe_timeout` and `probe_interval` for unstable networks
   - Check for network congestion or packet loss

3. **Encryption errors**
   - Verify all nodes use the same `secret_key`
   - Ensure key length is exactly 16, 24, or 32 bytes

4. **Load balancer not updating**
   - Verify `extension_id` matches the memberlist extension name
   - Check that the extension is listed in `service.extensions`

### Debug Logging

Enable debug logging to see detailed cluster information:

```yaml
service:
  telemetry:
    logs:
      level: debug
```

## Performance

The memberlist protocol is designed to be efficient and scalable:

- **Bandwidth**: Gossip traffic scales logarithmically with cluster size
- **Convergence**: Membership changes propagate in O(log N) time
- **CPU Usage**: Minimal CPU overhead for gossip maintenance
- **Memory Usage**: Memory usage is proportional to cluster size

## Limitations

- **Bootstrap Dependency**: At least one seed node must be available for new nodes to join
- **Network Partitions**: During partitions, the cluster may split but will heal when connectivity is restored
- **Clock Skew**: Large clock differences between nodes may affect failure detection timing

## Related Components

- [Load Balancing Exporter](../../exporter/loadbalancingexporter/README.md): Primary consumer of memberlist for service discovery
- [Health Check Extension](../healthcheckextension/README.md): Can be used alongside memberlist for health monitoring
